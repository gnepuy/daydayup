[TOC]



## 1. patch ç”Ÿæ•ˆçš„æ¡ä»¶

- **è¢« patch çš„ rb ä»£ç ** å¿…é¡»è¦ä¸ **è°ƒç”¨ patch çš„ rb ä»£ç ** å¤„äº **åŒä¸€ä¸ªè¿›ç¨‹** ä¸­
- ç¬¬ä¸€æ­¥: åŠ è½½ **éœ€è¦è¢« patch** çš„ rb æ–‡ä»¶åˆ°å†…å­˜
- ç¬¬äºŒæ­¥: ä¿®æ”¹ä¸º **patch ä¹‹å** çš„æ–¹æ³•å®ç°



## 2. é‡æ–°æ‰“å¼€ä¸€ä¸ªç±»

```ruby
# ç³»ç»Ÿ String ç±»æ·»åŠ æ–°çš„æ–¹æ³•
class String
 def pluralize(count = nil, locale = :en)
    locale = count if count.is_a?(Symbol)
    if count == 1
      dup
    else
      ActiveSupport::Inflector.pluralize(self, locale)
    end
  end
end
```



## 3. prepend

### 1. å•æ–‡ä»¶

```ruby
# 1ã€åŸå§‹ç±»
class Animal
  def cry
    puts '---- Animal cry ----'
  end
end

# 2ã€åœ¨ patch ä¹‹å‰ï¼Œä½¿ç”¨åŸå§‹ç±»
Animal.new.cry
puts '*' * 50

# 3ã€å°† ptach Animal#cry() çš„æ–°æ–¹æ³•å®ç°ï¼Œå°è£…åˆ°ä¸€ä¸ª module
module AnimalPatch
  # patch Animal#cry() æ–¹æ³•å®ç°
  def cry
    # 3.1ã€è¦†ç›– module ä¸­çš„æ–¹æ³•å®ç°
    puts '---- AnimalPatch cry -----'

    # 3.2ã€è°ƒç”¨ Animal ä¸­çš„æ–¹æ³•å®ç°
    super
  end
end

# 4ã€é‡æ–°æ‰“å¼€ Animal ç±»ï¼Œä½¿ç”¨ `Target å¤´æ’` æ–¹å¼åŒ…å« module 
class Animal
  prepend AnimalPatch   # æ–¹æ³•æœç´¢é¡ºåº: AnimalPatch#cry() -> Animal#cry()
  # include AnimalPatch # æ–¹æ³•æœç´¢é¡ºåº: Animal#cry() -> AnimalPatch#cry() åˆ™æ— æ³•å®Œæˆ patch
end

# 5ã€åœ¨ patch ä¹‹åï¼Œä½¿ç”¨åŸå§‹ç±»
Animal.new.cry
```

```
 ~/Desktop/main î‚° ruby main.rb
---- Animal cry ----
**************************************************
---- AnimalPatch cry -----
---- Animal cry ----
```

- 1) å…ˆä» **prepend** ç»§æ‰¿çš„ **module AnimalPatch** ä¸­æŸ¥æ‰¾ **cry()**
- 2) å½“ **module AnimalPatch#cry()** æ‰§è¡Œå®Œæ¯•å, å†è°ƒç”¨ **Animal#cry()**

### 2. åˆ†æ–‡ä»¶

#### 1. animal.rb

```ruby
class Animal
  def cry
    puts '---- Animal cry ----'
  end
end
```

#### 2. main.rb

```ruby
# 1ã€å¯¼å…¥è¦è¢« patach åæ‰§è¡Œçš„ rb æ–‡ä»¶
require_relative 'animal'

# 2ã€patch ä¹‹å‰ï¼Œä½¿ç”¨ Animal ç±»
Animal.new.cry
puts '*' * 50

# 3ã€å°† ptach Animal#cry() çš„æ–°æ–¹æ³•å®ç°ï¼Œå°è£…åˆ°ä¸€ä¸ª module
module AnimalPatch
  # patch Animal#cry() æ–¹æ³•å®ç°
  def cry
    # 3.1ã€è¦†ç›– module ä¸­çš„æ–¹æ³•å®ç°
    puts '---- AnimalPatch cry -----'

    # 3.2ã€è°ƒç”¨ Animal ä¸­çš„æ–¹æ³•å®ç°
    super
  end
end

# 4ã€é‡æ–°æ‰“å¼€ Animal ç±»ï¼Œä½¿ç”¨ `Target å¤´æ’` æ–¹å¼åŒ…å« module 
class Animal
  prepend AnimalPatch   # æ–¹æ³•æœç´¢é¡ºåº: AnimalPatch#cry() -> Animal#cry()
  # include AnimalPatch # æ–¹æ³•æœç´¢é¡ºåº: Animal#cry() -> AnimalPatch#cry() åˆ™æ— æ³•å®Œæˆ patch
end

# 5ã€patch ä¹‹åï¼Œä½¿ç”¨ Animal ç±»
Animal.new.cry
```

æ‰§è¡Œç»“æœ

```
 ~/Desktop/main î‚° ruby main.rb
---- Animal cry ----
**************************************************
---- AnimalPatch cry -----
---- Animal cry ----
```

#### 3. æ€»ç»“

- 1ã€éœ€è¦åœ¨ **åŒä¸€ä¸ªè¿›ç¨‹**
- 2ã€åŠ è½½éœ€è¦è¢« **patch** çš„ rb æ–‡ä»¶
- 3ã€ç„¶åå†ä½¿ç”¨ **patch ä¹‹å** çš„ rb æ–‡ä»¶å†…çš„ ç¬¦å·

### 3. çœŸå®ç¤ºä¾‹

patch `Pod::Installer#generate_pods_project()` æ–¹æ³•å®ç°ï¼š

```ruby
require 'erb'
require 'fileutils'
require 'xcodeproj'
require 'pp'

module ZHLogger
  def generate_pods_project
    # puts "Generating ZHLogger context files"
    # generator = LoggerGenerator.new(logger_context)
    # generator.generateToPodPath(sandbox.pod_dir('ZHMiddlewareModuleMap') + 'Classes/LoggerContext')
    puts sandbox.class
    puts "generate_pods_project: #{sandbox.pod_dir('ZHMiddlewareModuleMap') + 'Classes/LoggerContext'}"
    super
  end
end

module Pod
  class Installer
    prepend ZHLogger
  end
end
```



## 4. refine + using (å¯é™åˆ¶ä½œç”¨åŸŸ)

### 1. ç»™ã€è‡ªå®šä¹‰ç±»ã€‘æ‰“è¡¥ä¸

```ruby
# 1ã€åŸå§‹ç±»
class Animal
  def cry
    puts '---- Animal cry ----'
  end
end

# 2ã€åœ¨ patch ä¹‹å‰ï¼Œä½¿ç”¨åŸå§‹ç±»
Animal.new.cry
puts '*' * 50

# 3ã€å°† ptach Animal#cry() çš„æ–¹æ³•å®ç°ï¼Œå•ç‹¬å°è£…åˆ°ä¸€ä¸ª module
module AnimalPatch
  # 
  # ç±»ä¼¼äºã€é‡æ–°æ‰“å¼€ã€‘Animal ä½œç”¨åŸŸ
  # 
  refine(Animal) do
    #ã€æ·»åŠ ã€‘æ–¹æ³•å®ç°
    def run()
      puts '---- AnimalPatch run ----'
    end

    #ã€ä¿®æ”¹ã€‘æ–¹æ³•å®ç°
    def cry
      # è¦†ç›– module ä¸­çš„æ–¹æ³•å®ç°
      puts '---- AnimalPatch cry ----'

      # è°ƒç”¨ Animal ä¸­çš„æ–¹æ³•å®ç°
      super
    end
  end
end

# 4ã€åœ¨ `å±€éƒ¨æ¨¡å—` ä¸­ï¼Œä½¿ç”¨è¡¥ä¸ç»™åŸå§‹ç±»Animalæ‰“è¡¥ä¸
#  - 1) åªæœ‰åœ¨ä½¿ç”¨ **using()** å¯¼å…¥çš„ **å±€éƒ¨ç©ºé—´** å†…å¯ç”¨
#  - 2) ä¸€æ—¦è¶…å‡ºä½œç”¨åŸŸï¼Œå°±è‡ªåŠ¨åˆ é™¤æ‰
#  - 3) æ‰€ä»¥åœ¨ åŒ¿åæ¨¡å— å¤–éƒ¨çš„ **å…¨å±€ä½œç”¨åŸŸ** å†…ï¼Œ**æ— æ³•** ä½¿ç”¨ patch ä¸­çš„æ–¹æ³•
Module.new do 
  # 4.1ã€åœ¨åŒ¿åæ¨¡å—å†…ï¼Œä¸´æ—¶ä½¿ç”¨ AnimalPatch è¿™ä¸ªæ¨¡å—
  using(AnimalPatch)

  # 4.2ã€ä½¿ç”¨åœ¨ HumanExtendModule æ¨¡å—å†…ï¼Œç»™ Human ç±»ï¼Œæ·»åŠ çš„å¯¹è±¡æ–¹æ³• cry()
  anim = Animal.new
  anim.cry() # ok
  anim.run() # ok
end

puts '*' * 50

# 5ã€åœ¨æ²¡æœ‰ä½¿ç”¨ using(AnimalPatch) çš„å¤–éƒ¨å…¨å±€ä½œç”¨åŸŸå†…ï¼Œåˆ™æ— æ³•ä½¿ç”¨ AnimalPatch ä¸­çš„è¡¥ä¸
anim = Animal.new
anim.cry() # ok
anim.run() # error
```

```
 ~/Desktop/main î‚° ruby main.rb
---- Animal cry ----
**************************************************
---- AnimalPatch cry ----
---- Animal cry ----
---- AnimalPatch run ----
**************************************************
---- Animal cry ----
main.rb:50:in `<main>': undefined method `run' for #<Animal:0x007fe8d4136720> (NoMethodError)
```

### 2. ç»™ã€ç³»ç»Ÿç±»ã€‘æ‰“è¡¥ä¸

```ruby
require 'delegate'

# ç»™Stringç±»æ‰“è¡¥ä¸
module StringExtendModule
  refine(String) do 
    def cry()
      puts 'String cry'
    end
  end
end

# åœ¨å±€éƒ¨æ¨¡å—ä¸­ï¼Œä½¿ç”¨è¡¥ä¸å®Œæˆç»™Humanæ·»åŠ cry()
module A
  # 1ã€åœ¨æ¨¡å—Aå†…ï¼Œä¸´æ—¶ä½¿ç”¨ StringExtendModule è¿™ä¸ªæ¨¡å—
  using(StringExtendModule) # using StringExtendModule

  # 2ã€ä½¿ç”¨åœ¨ HumanExtendModule æ¨¡å—å†…ï¼Œç»™ String ç±»ï¼Œæ·»åŠ çš„å¯¹è±¡æ–¹æ³• cry()
  '....'.cry() # ok
end

puts '---------------'

# 4ã€å¹¶æ²¡æœ‰åœ¨ã€å…¨å±€ä½œç”¨åŸŸã€‘å†…ç»™Stringæ·»åŠ cry()ï¼Œæ‰€ä»¥æ­¤å¤„è°ƒç”¨ä¼šã€æŠ¥é”™ã€‘
'....'.cry() # error
```

```
 ~/Desktop/main î‚° ruby main.rb
String cry
---------------
main.rb:24:in `<main>': undefined method `cry' for "....":String (NoMethodError)
Did you mean?  crypt
```



## 5. instance_method + define_method

```ruby
module Pod
  class Installer
    def self.force_disable_integration(value)
      @@force_disable_integration = value
    end
		
    # 1ã€è·å– print_post_install_message åŸå§‹å®ç°
    old_method = instance_method(:print_post_install_message)
    # pp "âš ï¸ old_method=#{old_method}"
    
    # 2ã€é€šè¿‡ define_method ã€æ›¿æ¢åŸæœ‰æ–¹æ³•å®ç°ã€‘
    # define_method() å¯ä»¥åœ¨ã€è¿è¡Œæ—¶ã€‘æ·»åŠ /ä¿®æ”¹ã€å¯¹è±¡æ–¹æ³•ã€‘
    define_method(:print_post_install_message) do
      pp "ğŸ‰ğŸ‰ğŸ‰ hook print_post_install_message"
      return if @@disable_install_complete_message
      old_method.bind(self).()
    end
  end
end
```



## 6. define_method + alias_method

- åœ¨æ·»åŠ çš„æ–¹æ³•ä¸­ï¼Œè°ƒç”¨ä¼ å…¥çš„ target çš„åŸå§‹æ–¹æ³•
- alias_method() å°† target.run ç¬¦å·èµ·åˆ«åä¸º target.alias_run

```ruby
class HumanProxy
  # å¯¹è±¡çš„åˆå§‹åŒ–æ–¹æ³•
  def initialize(target)
    # 1. åˆ›å»ºä¸€ä¸ªå±€éƒ¨çš„ `åŒ¿å module` è´Ÿè´£å®Œæˆç»™ init(target) ä¼ å…¥çš„ target å¯¹è±¡ï¼Œ
    # - 1) åŠ¨æ€æ·»åŠ  `å¯¹è±¡æ–¹æ³•`
    # - 2) ç¬¦å·åˆ«å
    # - 3) è°ƒç”¨ `åŸå§‹çš„å¯¹è±¡æ–¹æ³•`
    aModule = Module.new() do
      # 1.1 åŠ¨æ€æ·»åŠ  `å¯¹è±¡æ–¹æ³•`
      target.public_methods(false).each() do |method|
        # 1.1.1
        alias_method_name = "alias_#{method}"
        
        # 1.1.2
        define_method(method) do |*args, &block|
          puts '--- begin ---'
          ret = target.send(method, *args, &block) # 1.3 è°ƒç”¨ `åŸå§‹çš„å¯¹è±¡æ–¹æ³•`
          puts '--- end ---'
          ret
        end
        
        # 1.1.3 ç¬¦å·åˆ«å
        alias_method(
          alias_method_name.to_sym(), # alias_run
          method.to_sym() # run
        )
      end
    end
    
    # 2. ä½¿ç”¨ module ä¸­å°è£…çš„ä»£ç 
    extend(aModule)
  end
end
```



## 7. forwardable

```ruby
module ForwardableTool
	# 1ã€æ¨¡å—æä¾›çš„åˆå§‹åŒ–å‡½æ•°
	def prepare()
    require('forwardable')
    extend(Forwardable) # extend()çš„æ¨¡å—å¹¶ã€ä¸å‚ä¸ã€‘classçš„ç»§æ‰¿ä½“ç³»
    include(Enumerable) # include()çš„æ¨¡å—ä¼šã€å‚ä¸ã€‘classçš„ç»§æ‰¿ä½“ç³»
	end

	# 2ã€å°è£… def_delegator(receivor, old_method, new_method) å‡½æ•°ä½¿ç”¨
  # => @param *methods åŒæ—¶æ¥æ”¶å¤šä¸ªmethod
	def define_delegator_methods(receivor, *methods)
    methods.each() do |method|
      def_delegator(receivor, method, method)
    end
	end
end

class MyHash
  # 1ã€åŒ…å«è‡ªå®šä¹‰çš„ ForwardableTool æ¨¡å—ï¼ˆå¤åˆ¶ module ä¸­æ‰€æœ‰çš„ å¯¹è±¡æ–¹æ³•ï¼Œåˆ°å½“å‰ MyHash ä¸­ï¼‰
  extend(ForwardableTool)

  # 2ã€è°ƒç”¨ä» ForwardableTool æ¨¡å—ä¸­å¤åˆ¶è¿‡æ¥çš„ å¯¹è±¡æ–¹æ³•
  prepare()

  # 3ã€initä¸­åˆ›å»ºhashï¼Œå¹¶è®¾ç½®è®¿é—®ä¸å­˜åœ¨çš„keyæ—¶å›è°ƒblockä»£ç å—
  attr_reader(:hash)
  def initialize
    @hash = Hash.new do |hash, key|
      raise(KeyError, "invalid key #{key}")
    end
  end

  # 4ã€è°ƒç”¨æ‰©å±•è‡ªmoduleä¸­å°è£…çš„æ¶ˆæ¯è½¬å‘å‡½æ•°
  define_delegator_methods(:@hash, :freeze, :taint, :untaint, :[], :[]=)
end

hash = MyHash.new
hash['key1'] = 'value1'
hash['key2'] = 'value2'
puts hash.hash
hash.freeze
hash.taint	# å› ä¸ºå†…éƒ¨hashå¯¹è±¡è¢«freezeå†»ç»“ï¼Œæ‰€ä»¥æ— æ³•è¿›è¡Œä¿®æ”¹
hash.untaint # åŒä¸Š
```



## 8. alias

```ruby
require_relative 'monkey'

# ç»™åŸå§‹ç±» Monkey æ‰“è¡¥ä¸
class MonkeyPatch < Monkey
  # 1ã€æ›¿æ¢ä¸ºçš„æ–¹æ³•
  def hello_patch 
    puts "MonkeyPatch hello"
  end
  
  # 2ã€æ›¿æ¢ MonkeyPatch ä¸­çš„ hello_patch ä¸º Monkey ä¸­çš„ patch
  alias hello hello_patch
end

# ä½¿ç”¨ patch ä¹‹åçš„ç±»å¯¹è±¡
m = MonkeyPatch.new

# è°ƒç”¨ åŸå§‹ç±»çš„ å¯¹è±¡æ–¹æ³•ï¼Œå…¶å®æ˜¯è°ƒç”¨ patch ä¹‹åçš„ç±»å¯¹è±¡
m.hello
```

```
 ~/Desktop/main î‚° ruby main.rb
MonkeyPatch hello
```

ç¼ºç‚¹ï¼šåç»­éœ€è¦ä½¿ç”¨ **patch ç±»** ä»£æ›¿ **åŸå§‹ç±»** .



## 9. undef + send

```ruby
# 1ã€è¢«æ‰“è¡¥ä¸çš„åŸå§‹ç±»
class Monkey 
  def method1 
    puts "--- method1 ---"
  end
end 
  
# 2ã€Monkey2 å¯¹ Monkey è¿›è¡Œæ‰“è¡¥ä¸
class Monkey2 < Monkey 
  def method2 
    puts "--- method2 ---"
  end
end
  
# 3ã€æ­£å¸¸è°ƒç”¨
monkey = Monkey2.new
monkey.method1
monkey.method2

puts '*' * 50
  
# 4ã€å¯¹ã€è¡¥ä¸ç±» Monkey2ã€‘è¿›è¡Œä¿®æ”¹
class Monkey2
  # åˆ é™¤æ–¹æ³•å®ç°
  undef method1
  undef method2

  # æ·»åŠ æ–°çš„æ–¹æ³•å®ç°
  Kernel.send(:define_method, :'method3') do
    puts '--- method3 ---'
  end
end
  
# 5ã€è°ƒç”¨æŠ¥é”™
# monkey.method1
# monkey.method2

# 6ã€ok
monkey.method3
```

```
 ~/Desktop/main î‚° ruby main.rb
--- method1 ---
--- method2 ---
**************************************************
--- method3 ---
```



## 10. remove_method/undef_method

```ruby
# 1ã€è¢«æ‰“è¡¥ä¸çš„åŸå§‹ç±»
class Monkey 
  def method1 
    puts "This is method1"
  end
end 
  
# 2ã€Monkey2 å¯¹ Monkey è¿›è¡Œæ‰“è¡¥ä¸
class Monkey2 < Monkey 
  def method2 
    puts "This is method2"
  end
end

# 3ã€
class Monkey2
 remove_method :method1
 undef_method :method2
end
```



## 11. singleton class

```ruby
class Array
  class << self
    def hint
      "hello"
    end
  end
end

puts Array.hint
```

```
 ~/main î‚° ruby main.rb
hello

```



## 12. æ€»è®¡æ¯”è¾ƒå¸¸ç”¨çš„

- 3
- 4
- 5
- 6
- 8